<!DOCTYPE html>
<HTML><HEAD>

  <!-- Page-specific metadata -->
  <title>The Library of Unwritten Books</title>
  <meta property="og:type" content="website"/>
	<meta property="og:title" content="The Library of Unwritten Books"/>
	<meta property="og:description" content="To check out an unwritten book, you must become a reader-author. Read; reply; repeat. Remember, what you read is a reflection of what you and other authors have written, and where one ends a story is at least as important as where one begins. "/>
  <meta property="og:image" content="http://www.davidcolarusso.com/images/50-days/library.png"/>
  <meta property="og:image:width" content="1024" />
  <meta property="og:image:height" content="576" />

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9L150R8REY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9L150R8REY');
  </script>

  <!-- Metadata for mobile -->
	<meta http-equiv="Content-type" content="text/html;charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0" />
  <meta name="apple-mobile-web-app-capable" content="no" />
  <link rel="apple-touch-icon" href="images/home_icon.png"/>

  <!-- JS & style -->
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
	<link rel="stylesheet" type="text/css" href="css/style.css?v=2024-07-21">
  <script src="js/functions.js?v=2024-07-21"></script>
  <script src="js/random_text.js?v=2024-07-21"></script>
  <script src="js/tts.js?v=2024-07-21"></script>

  <!-- AddToAny -->
  <script>
    var a2a_config = a2a_config || {};
    a2a_config.num_services = 10;
    a2a_config.show_title = 1;
  </script>
  <script async src="https://static.addtoany.com/menu/page.js" onerror="share.innerHTML='';"></script>

  <script src="js/encryption.js?v=2024-07-21"></script>

<script>

localStorage.setItem('templates',JSON.stringify({
  "Read-write a new story": {
    "prompt": "Produce a JSON object where the key is \"genre\" and the value is ```{{Q1 of 6. What genre does this story belong to (e.g., sci-fi, realistic fiction, romance)?}}```",
    "model": "gpt-4o-mini",
    "temperature": 0,
    "max_tokens": 500,
    "output": 1,
    "json_mode": 1,
    "output_to": 4,
    "behavior": "Frame",
    "hide_button": false
  },
  "Frame": {
    "prompt": "You are the game master for a table-top role-playing game. You are playing with one other player. They will inhabit the role of the protagonist, making decisions for how they move through the world. You will craft a story around their decisions, providing texture and playing the parts of all the other characters. First, I'm going to give you some context so you understand the narrative expectations. \n\n========\n\nSetting and genre: \n\n- Your story telling should adhere to the following genre expectations: {{Q1 of 6. What genre does this story belong to (e.g., sci-fi, realistic fiction, romance)?}}\n- Your story will start at the following place: {{Q2 of 6. Where does your story take place?}}\n- Your story is set at the following time: {{Q3 of 6. When does your story take place?}}\n\n========\n\nThe Protagonist:\n\nEarlier you asked the other player to fill in a character sheet for the protagonist. Here are their answers. Use them to help you shape the story.\n\n- name: {{Q4 of 6. What is your character's name?}}\n- additional notes: {{Q5 of 6. Anything else I should know that's important to your character (e.g., age, gender, sexual orientation, physical appearance, background)? Keep it brief, and it's okay to say, \"No.\"}}\n\n========\n\nAdditional Notes:\n\nYou also asked them if there was anything else would like you to incorporate into the story. This is what they said: \n\n{{Q6 of 6. Is there anything else you would like me to incorporate into the story? Special \"notes\" you have for this story? Please, keep it short, and it's okay to say, \"No.\"}}\n\n========\n\nStory Arc:\n\nAs the story unfolds you should help shape it to follow this basic structure: \n\n- Section 1 (Exposition): The beginning of the story where the characters, setting, and background information are introduced.\n- Section 2 (Rising Action): The series of events that build tension and develop the conflict. This part of the story usually includes obstacles, challenges, and complications that the characters must face.\n- Section 3 (Climax): The turning point or the highest point of intensity in the story. It is the moment where the conflict reaches its peak, and the outcome is uncertain. The climax often involves a significant decision, confrontation, or revelation.\n- Section 4 (Falling Action): The events that occur after the climax, where the tension starts to decrease. Loose ends are tied up, and the story begins to move towards its resolution.\n- Section 5 (Resolution): The final part of the story where the conflict is resolved, and the loose ends are tied up. It provides closure and answers any remaining questions. The resolution can be either positive or negative, depending on the outcome of the story. \n\n========\n\nStyle:\n\nUnless the other player said otherwise, your prose should be high quality like that you would find in a published book with plenty of dialogue. You avoid repeating yourself and try for a coherent story. You also favor describing events over exposition. You follow the writing advice, show don't tell. \n\n========\n\n\n",
    "model": "",
    "temperature": 0.7,
    "max_tokens": 250,
    "output": 0,
    "json_mode": 0,
    "output_to": 7,
    "behavior": "Introduction",
    "hide_button": true
  },
  "Pick up where you left off": {
    "prompt": "{{scratch}}\n\n========\n\nAbove is a story in progress. Provide a short recap of what's happened so far as if catching the protagonist up on their actions. Be sure to provide enough detail so we know where we left the protagonist at the end of the story so far. Do, however, keep it short. Write no more than three paragraphs. \n\n",
    "model": "gpt-4o-mini",
    "temperature": 0.7,
    "max_tokens": 1000,
    "output": 1,
    "json_mode": 0,
    "output_to": 0,
    "behavior": "Role Play 01",
    "hide_button": false
  },
  "Introduction": {
    "prompt": "{{scratch}}\n\nGiven the above, write the first two or three paragraphs for the story. Lean heavily into genre expectations. The text should move the story forward and set the stage for the protagonist to take action. The prose should read like that of a novel with plenty of depth and some dialogue. When you're done, I'd like you to return your answer as a JSON object with two key-value pairs. The first key is \"opening\" and its value should be the opening text of the story. The second key is \"title\" and it contains an evocative and appropriate title for the type of story you want to tell. \n\n",
    "model": "gpt-4o",
    "temperature": 0.9,
    "max_tokens": 1000,
    "output": 1,
    "json_mode": 1,
    "output_to": 4,
    "behavior": "The story begins",
    "hide_button": true
  },
  "The story begins": {
    "prompt": "{{passThrough[\"title\"]}}\n\n{{passThrough[\"opening\"]}}\n\n",
    "model": "",
    "temperature": 0.7,
    "max_tokens": 250,
    "output": 0,
    "json_mode": 0,
    "output_to": 2,
    "behavior": "Role Play 01",
    "hide_button": true
  },
  "Role Play 01": {
    "prompt": "{{scratch}}\n\n========\n\nRemember, you are the game master for a table-top role-playing game. Above is the story so far. You are playing with one other player. They inhabit the role of the protagonist, making decisions for how they move through the world. You craft a story around their decisions, providing texture and playing the parts of all the other characters, speaking and acting for them as needed. You ask the player who is playing the protagonist what they want to do next, and this is their answer:\n\n{{What do you want to do?*}}\n\n========\n\nTo determine if they are successful, start by assessing the likelihood of success for the above action given what you know about the story so far and the relevant genre conventions. Also, consider what you know of the character's skills and motivations and how those might effect the outcome. That is, figure out how hard it will be for the protagonist to do what they want to. Label this difficulty with one of the following labels: \n\n- Easy\n- Medium\n- Hard\n\nNow we're going to role a 20-sided dice to see if they are successful. Okay, the dice roll was {{d20}}.\n\nIf the difficulty was Easy, the roll ({{d20}}) has to be greater than or equal to 0 for them to succeed. \n\nIf the difficulty was Medium, the roll ({{d20}}) has to be greater than or equal to 4 for them to succeed. \n\nIf the difficulty was Hard, the roll ({{d20}}) has to be greater than or equal to 10 for them to succeed. \n\nReturn a selection of prose, 1 to 2 paragraphs, explaining what happened (i.e., describing what the protagonist did and their success or failure). Be sure to include dialogue when appropriate. The prose should flow naturally from the story so far (text above). Assume that the reader does not know what the player said the protagonist wanted to do. You should include details over generalities. Instead of explaining that something occurred, describe each of the events and actions that took place. Show don't tell! Format your reply in JSON with the following key-value pairs:\n\n1. key=\"difficulty\" and the value is the label you applied above.\n2. key=\"difficulty_cutoff\" and the value is the numeric cutoff for the specified difficulty. \n3. key=\"roll\" and the value is the outcome of the above dice roll.\n4. key=\"success\" and the value is 1 if roll is greater than or equal to the difficulty_cutoff. \n5. key=\"narrative\" and the value is the prose you produce describing what happened.\n\nAnd again, remember to show with your words, don't tell. Walk through events and actions one by one in great detail. Also, if this event seems too much like what has come before, take it in a different direction. Avoid repeating phrases that already appear in the story. Don't hide information in the protagonist's mind. The reader should know everything they do and in detail. \n",
    "model": "gpt-4o-mini",
    "temperature": 0.8,
    "max_tokens": 1000,
    "output": 1,
    "json_mode": 1,
    "output_to": 4,
    "behavior": "move forward",
    "hide_button": true
  },
  "move forward": {
    "prompt": "{{passThrough[\"narrative\"]}}\n\n",
    "model": "",
    "temperature": 0.7,
    "max_tokens": 250,
    "output": 0,
    "json_mode": 0,
    "output_to": 2,
    "behavior": "move forward 2",
    "hide_button": true
  },
  "move forward 2": {
    "prompt": "You're helping write a short story. In a moment I'll give you the text so far, and I want you to add a beat, probably about two or three paragraphs worth, more if it includes dialogue. The text should move the story forward and set the stage for the protagonist to take action. Here's what you have so far: \n\n{{scratch}}\n\n---\n\nWrite the next beat of the story. Be sure to include dialogue when appropriate, and don't try to cram a lot of exposition in, opt instead for setting the protagonist up to take action. Show don't tell. Return your answer as a JSON object where the key is \"next_beat\" and the value what you would like to add to the story. Pay particular attention to all of the story so far to make sure the next beat (this bit) makes sense. \n\n\"next_beat\" should be no more than three paragraphs. It can go two ways: \n\n(1) the section continues and the beat stops after setting the stage for the protagonist to act; or \n\n(2) you decide the section should end because it has done its job as described under the Story Arc. For a section to end, it must have run its course as specified by the Story Arc (e.g., the first section should involve Exposition and the last Resolution). If you think we're at the end of a section, \"next_beat\" should be the beginning of the next section and it should start with \"---\\n\\n,\" where \"\\n\\n\" is a double carriage return. This section break should be followed by an opening paragraph for the new section, setting things up with the section's goal in mind. \n\nIf you're writing a new section (2 above), either change the setting or advance the time to keep things moving. \n\nIf you are continuing the section (1 above), move things towards that section's goals as you understand them, but do NOT jump over any time, place the action directly following the last beat.\n\nEither way, you should move the story forward adding detail and plot points. Make it count. No vague flowery fluff, and make sure your prose follows naturally from the story so far, as described above. Avoid repeating phrases that already appear in the story, and don't use the \"un-Reveal trope\" (i.e., if the reader is promised a secret or introduced to some cryptic plot element, cut to the chase, and reveal the secret or explain the meaning to the reader right away). If you need more space to do this, add a paragraph. Don't hide information in the protagonist's mind. The reader should know everything they do and in detail. This doesn't mean you have to tell us everything they're feeling only what they know.\n",
    "model": "gpt-4o-mini",
    "temperature": 0.8,
    "max_tokens": 1000,
    "output": 1,
    "json_mode": 1,
    "output_to": 4,
    "behavior": "append 2",
    "hide_button": true
  },
  "append 2": {
    "prompt": "{{passThrough[\"next_beat\"]}}\n\n",
    "model": "",
    "temperature": 0.7,
    "max_tokens": 250,
    "output": 0,
    "json_mode": 0,
    "output_to": 2,
    "behavior": "Role Play 01",
    "hide_button": true
  },
  "Download current story": {
    "prompt": "{{scratch}}",
    "model": "",
    "temperature": 0.7,
    "max_tokens": 250,
    "output": 0,
    "json_mode": 0,
    "output_to": 4,
    "behavior": "file",
    "hide_button": false
  }
}));


//fgnass.github.com/spin.js#v1.2.7
!function(e,t,n){function o(e,n){var r=t.createElement(e||"div"),i;for(i in n)r[i]=n[i];return r}function u(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function f(e,t,n,r){var o=["opacity",t,~~(e*100),n,r].join("-"),u=.01+n/r*100,f=Math.max(1-(1-e)/t*(100-u),e),l=s.substring(0,s.indexOf("Animation")).toLowerCase(),c=l&&"-"+l+"-"||"";return i[o]||(a.insertRule("@"+c+"keyframes "+o+"{"+"0%{opacity:"+f+"}"+u+"%{opacity:"+e+"}"+(u+.01)+"%{opacity:1}"+(u+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+f+"}"+"}",a.cssRules.length),i[o]=1),o}function l(e,t){var i=e.style,s,o;if(i[t]!==n)return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(o=0;o<r.length;o++){s=r[o]+t;if(i[s]!==n)return s}}function c(e,t){for(var n in t)e.style[l(e,n)||n]=t[n];return e}function h(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)e[i]===n&&(e[i]=r[i])}return e}function p(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}var r=["webkit","Moz","ms","O"],i={},s,a=function(){var e=o("style",{type:"text/css"});return u(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),d={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"},v=function m(e){if(!this.spin)return new m(e);this.opts=h(e||{},m.defaults,d)};v.defaults={},h(v.prototype,{spin:function(e){this.stop();var t=this,n=t.opts,r=t.el=c(o(0,{className:n.className}),{position:n.position,width:0,zIndex:n.zIndex}),i=n.radius+n.length+n.width,u,a;e&&(e.insertBefore(r,e.firstChild||null),a=p(e),u=p(r),c(r,{left:(n.left=="auto"?a.x-u.x+(e.offsetWidth>>1):parseInt(n.left,10)+i)+"px",top:(n.top=="auto"?a.y-u.y+(e.offsetHeight>>1):parseInt(n.top,10)+i)+"px"})),r.setAttribute("aria-role","progressbar"),t.lines(r,t.opts);if(!s){var f=0,l=n.fps,h=l/n.speed,d=(1-n.opacity)/(h*n.trail/100),v=h/n.lines;(function m(){f++;for(var e=n.lines;e;e--){var i=Math.max(1-(f+e*v)%h*d,n.opacity);t.opacity(r,n.lines-e,i,n)}t.timeout=t.el&&setTimeout(m,~~(1e3/l))})()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=n),this},lines:function(e,t){function i(e,r){return c(o(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:r,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*n+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.corners*t.width>>1)+"px"})}var n=0,r;for(;n<t.lines;n++)r=c(o(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:s&&f(t.opacity,t.trail,n,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&u(r,c(i("#000","0 0 4px #000"),{top:"2px"})),u(e,u(r,i(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}}),function(){function e(e,t){return o("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=c(o("group"),{behavior:"url(#default#VML)"});!l(t,"transform")&&t.adj?(a.addRule(".spin-vml","behavior:url(#default#VML)"),v.prototype.lines=function(t,n){function s(){return c(e("group",{coordsize:i+" "+i,coordorigin:-r+" "+ -r}),{width:i,height:i})}function l(t,i,o){u(a,u(c(s(),{rotation:360/n.lines*t+"deg",left:~~i}),u(c(e("roundrect",{arcsize:n.corners}),{width:r,height:n.width,left:n.radius,top:-n.width>>1,filter:o}),e("fill",{color:n.color,opacity:n.opacity}),e("stroke",{opacity:0}))))}var r=n.length+n.width,i=2*r,o=-(n.width+n.length)*2+"px",a=c(s(),{position:"absolute",top:o,left:o}),f;if(n.shadow)for(f=1;f<=n.lines;f++)l(f,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(f=1;f<=n.lines;f++)l(f);return u(t,a)},v.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}):s=l(t,"animation")}(),typeof define=="function"&&define.amd?define(function(){return v}):e.Spinner=v}(window,document);


function copy_to_clipboard(text) {
    // Create a temporary textarea element to store the result
    var tempTextArea = document.createElement('textarea');
    tempTextArea.value = text;
  
    // Append the textarea to the document
    document.body.appendChild(tempTextArea);
  
    // Select the text within the textarea
    tempTextArea.select();
  
    // Copy the selected text to the clipboard
    document.execCommand('copy');
  
    // Remove the temporary textarea
    document.body.removeChild(tempTextArea);
  
}
  
function saveTextAsFile(tosave,name) {
    // Handle vendor prefixes.
    window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
  
    // tosave = ID of textarea to save
    // name = name to save file as, including file extension     
    // grab the content of the form field and place it into a variable
    var textToWrite = tosave //document.getElementById(tosave).value;
    //  create a new Blob (html5 magic) that conatins the data from your form feild
    var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});
        
    // Specify the name of the file to be saved
    var fileNameToSaveAs = name;
        
    // Optionally allow the user to choose a file name by providing 
    // an imput field in the HTML and using the collected data here
    // var fileNameToSaveAs = txtFileName.text;
  
    // create a link for our script to 'click'
    var downloadLink = document.createElement("a");
    // supply the name of the file (from the var above).
    // you could create the name here but using a var
    // allows more flexability later.
    downloadLink.download = fileNameToSaveAs;
    // provide text for the link. This will be hidden so you
    // can actually use anything you want.
    downloadLink.innerHTML = "My Hidden Link";
        
    // allow our code to work in webkit & Gecko based browsers
    // without the need for a if / else block.
    window.URL = window.URL || window.webkitURL;
            
    // Create the link Object.
    downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
    // when link is clicked call a function to remove it from
    // the DOM in case user wants to save a second file.
    downloadLink.onclick = destroyClickedElement;
    // make sure the link is hidden.
    downloadLink.style.display = "none";
    // add the link to the DOM
    document.body.appendChild(downloadLink);
        
    // click the new link
    downloadLink.click();
}
  
function destroyClickedElement(event) {
    // remove the link from the DOM
    document.body.removeChild(event.target);
}

function loadFile(filePath) {
    return fetch(filePath)
    .then(response => response.text())
    .then(data => {
        return data
    })
};
  
  //localStorage.setItem('default_templates', JSON.stringify(default_prompts));
  
  if (localStorage.templates) {
      templates = JSON.parse(localStorage.templates)
  } //else {
    //  localStorage.setItem('templates', JSON.stringify(default_prompts));
    //  templates = JSON.parse(JSON.stringify(default_prompts))
  //}

//
// Load defaults
//

if (localStorage.api_key) {
  api_key = localStorage.api_key
} else {
  api_key = ""
  localStorage.setItem('api_key',api_key)
}


// user decrypt
if (localStorage.api_key=="") {
    (async () => {
        api_key = await decryptData("Wky0qurBodVqo1bcYuWd44yeBNqj0krAwoE/QDGV82U1CBfKfUOI6sR+zreeinlVH3eTPHWQHVl/rwcOisk5/xvImtM24FAxqBT2NTHb7ofsqVEcOK7i7GQ3lzFILLOXDHa00Q==","General")
    })()
}

if (localStorage.api_base) {
  api_base = localStorage.api_base
} else {
  api_base = "https://api.openai.com/v1/chat/completions"
  localStorage.setItem('api_base',api_base)
}

var bodyText = "";
var selectedText = "";
var question_arry = {};
var last_question = "";
var output_type = "";
var llm_prompt = "";
var llm_messages = [];
var LLM_text_collection = "";
var model = "";
var template = "";
var temperature = 0;
var max_tokens = 0;
var json_mode = 0;
var output_to = 0;
var behavior = "";
var passThrough = "";
var bubble = 0;
var calls = 0;
var visible_calls = 0;

popup_CSS = `* {
  box-sizing: border-box;
}

input:focus, textarea {
  outline: none;
}

body {
  /*--
  font-family: georgia, 'times new roman', times, serif; issues with accents like Äƒ
  --*/
  font-family: SÃ¶hne,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
  box-sizing: border-box;
}

#scratch_pad {
  box-sizing: border-box;
  width:100%;
  height:100%;
  padding:20px;
  border:0px solid #ccc;
  resize: none;
  overflow-y: auto;
}

.text_wrap{
  float:left;
  width:100%;
  margin:0;
  padding:0;
}

.input_text {
  float:right;
  font-size: 16px;
  line-height: 20px;
  margin: 0px 5px 15px 0;
  max-width:100%;
  margin-left:20%;
  background:#eee;
  border-radius:8px;
  padding:15px;
}

.output_text {
  float:left;
  background:#425dd4;
  font-size: 16px;
  line-height: 20px;
  color: white;
  border-radius:8px;
  margin: 0px 0 15px 0;
  max-width:80%;
  padding:15px;
}

.speak {
  float:right;
}

code {
  background:#2c3e8e;
}

.code_wrapper {
  padding:3px;
  margin: 0px;
  width:100%;
  overflow-x: auto;
  background:#2c3e8e;
}

.msg_text {
  float:left;
  font-family: Verdana, Geneva, sans-serif;
  font-variant: small-caps;
  width:100%;
  text-align: center;
  font-size: 14px;
  color:#7d7878;
  margin:0 0 15px 0;
}`

//
// General functions
//

function start_spinner(target_id) {
  var opts = {
    lines: 13, // The number of lines to draw
    length: 7, // The length of each line
    width: 4, // The line thickness
    radius: 10, // The radius of the inner circle
    corners: 1, // Corner roundness (0..1)
    rotate: 0, // The rotation offset
    color: '#909090', // #rgb or #rrggbb
    speed: 1, // Rounds per second
    trail: 60, // Afterglow percentage
    shadow: false, // Whether to render a shadow
    hwaccel: false, // Whether to use hardware acceleration
    className: 'spinner', // The CSS class to assign to the spinner
    zIndex: 2e9, // The z-index (defaults to 2000000000)
    top: '15', // Top position relative to parent in px
    left: '0' // Left position relative to parent in px
  };
  var target = document.getElementById(target_id);
  var spinner = new Spinner(opts).spin(target);
}

document.addEventListener('DOMContentLoaded', function () {

  var myButton = document.getElementById('send');
  myButton.addEventListener('click', function() {
    submit_text();
  });  

  var myButton = document.getElementById('random');
  myButton.addEventListener('click', function() {
    random_text();
  });  

  var myChatAns = document.getElementById('chat_user_input');
  myChatAns.addEventListener('keydown', submitChatOnEnter);  

  var myChatButton = document.getElementById('chat_send');
  myChatButton.addEventListener('click', function() {
    submit_chat_text();
  });    

  var myContinueButton = document.getElementById('continueButton');
  myContinueButton.addEventListener('click', function() {
    submit_continue();
  });    

  var toPromptButton = document.getElementById('toPrompt');
  toPromptButton.addEventListener('click', function() {
    choose_prompt();
  });

  var credentialsButton = document.getElementById('credentialsButton');
  credentialsButton.addEventListener('click', function() {
    saveAPICred();
  });

  document.getElementById("api_base").addEventListener("keydown", saveOnEnter);
  document.getElementById("api_key").addEventListener("keydown", saveOnEnter);

  //var mySettings = document.getElementById('config');
  //mySettings.addEventListener('click', function() {
  //  window.open("options.html", 'options').focus();
  //});

  //var myScratch = document.getElementById('scratch');
  //myScratch.addEventListener('click', function() {
  //  window.open("scratch.html", 'scratch').focus();
  //});

  //var myAbout = document.getElementById('about');
  //myAbout.addEventListener('click', function() {
  //  window.open("https://github.com/SuffolkLITLab/prompts", '_projectPage').focus();
  //});

  //var myFeedback = document.getElementById('feedback');
  //myFeedback.addEventListener('click', function() {
  //  window.open("https://github.com/SuffolkLITLab/prompts/issues", '_logIssues').focus();
  //});

  var save_transcript = document.getElementById('save_transcript');
  save_transcript.addEventListener('click', function() {
      const d = new Date();
      const day_list = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const month_list = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      saved_on =  day_list[d.getDay()] + ", " + month_list[d.getMonth()] + " " + d.getDate() + ", " + d.getFullYear();

      transcript_html = "<html>\n<head>\n<title>Transcript: "+ saved_on +"</title><style>\n"+popup_CSS+"\n</style>\n</head>\n<body>\n";
      transcript_html += document.getElementById('transcript').innerHTML;
      transcript_html += "<div class='msg_text'>Saved "+saved_on+" at " + (d.getHours() % 12 || 12) + ":" + ('0' + d.getMinutes()).slice(-2) + " " + (d.getHours() >= 12 ? 'pm' : 'am') + "</div>"
      transcript_html += "\n</body>\n</html>";
      saveTextAsFile(transcript_html,"transcript_"+d.getFullYear()+"-"+('0'  + d.getMonth()).slice(-2)+"-"+('0'  + d.getDate()).slice(-2)+"T"+('0'  + d.getHours()).slice(-2)+('0' + d.getMinutes()).slice(-2)+('0'  + d.getSeconds()).slice(-2)+".html")
  });

  document.getElementById("restartButton").addEventListener("click", function() {
    location.reload();
  });

  document.getElementById("restartButton_companion").addEventListener("click", function() {
    location.href=".";
    //location.reload();
  });

  if (!localStorage.scratch_pad) {
    localStorage.setItem('scratch_pad',"")
  } //else {
     //document.getElementById('scratch_pad').value = localStorage.scratch_pad
  //}  

  var BORDER_SIZE = 8;
      
  let m_pos;
  //function resize(e){
  //  if (window.innerWidth>=458) {
  //    const dx = m_pos - e.x;
  //    m_pos = e.x;
  //    panel_width = parseInt(getComputedStyle(panel, '').width)
  //    if (panel_width<180) {
  //      panel_width = 181;
  //    } else if ((window.innerWidth-panel_width)< 90) {
  //      panel_width = window.innerWidth - 91;
  //    }
  //    panel.style.width = (panel_width + dx) + "px";
  //    panel_l.style.right = (panel_width + dx) + "px";
  //    localStorage.panel_w = (panel_width + dx);  
  //  } else {
  //    panel.style.width = "100%"
  //    panel_l.style.right = "100%"
  //  }
  //}

  //if (window.innerWidth>=458) {
  //  panel_width = localStorage.panel_w
  //  if ((panel_width=="100%") & (window.getComputedStyle(document.getElementById("inline_scratch"), null).display =="none")) {
  //    document.getElementById("main_wrapper").style.width = "100%"
  //    document.getElementById("inline_scratch").style.right = "100%"  
  //  } else if (panel_width>(window.innerWidth-80)) {
  //    document.getElementById("main_wrapper").style.width =  "50%"
  //    document.getElementById("inline_scratch").style.right = "50%"
  //  } else if (panel_width>0) {
  //    document.getElementById("main_wrapper").style.width = localStorage.panel_w + "px";
  //    document.getElementById("inline_scratch").style.right = (parseInt(localStorage.panel_w)) + "px";
  //  } else {
  //    if (window.getComputedStyle(document.getElementById("inline_scratch"), null).display =="none") {
  //      document.getElementById("main_wrapper").style.width = "100%"
  //      document.getElementById("inline_scratch").style.right = "100%"    
  //    } else {
  //      panel_width = 450;
  //      localStorage.panel_w = panel_width
  //      document.getElementById("main_wrapper").style.width = localStorage.panel_w + "px";
  //      document.getElementById("inline_scratch").style.right = (parseInt(localStorage.panel_w)) + "px";  
  //    }
  //  }
  //} else {
    document.getElementById("main_wrapper").style.width = "100%"
  //  document.getElementById("inline_scratch").style.right = "100%"
  //  localStorage.panel_w = "100%"
  //}

  var panel = document.getElementById("main_wrapper");
  panel.addEventListener("mousedown", function(e){
    if (e.offsetX < BORDER_SIZE) {
      m_pos = e.x;
      document.addEventListener("mousemove", resize, false);
    }
  }, false);
  
  //var panel_l = document.getElementById("inline_scratch");
  //document.addEventListener("mouseup", function(){
  //    document.removeEventListener("mousemove", resize, false);
  //}, false);

  // Save text to localStorage on change
  //document.getElementById('scratch_pad').addEventListener('input', function() {
  //  localStorage.setItem('scratch_pad', this.value);
  //  current_text = this.value;
  //});

});

//
// Construct, submit, and handel prompts
//

function choose_prompt(choice) {

  document.getElementById('unfinished').style.display='none';

  calls+=1;
  console.log("Choosing template: "+choice)
  console.log("Runs w/o interaction: "+calls)

  if (calls>=20) {
    if (confirm(`Are you in a loop? You've made 20 prompt calls without human interaction. Choose "OK" to continue or "Cancel" to stop here.`) == true) {
      calls = 0;
      visible_calls = 0;
    } else {
      insert_restart();
    }
  }

  if (calls<20) {

    output_type = templates[choice]["output"]
    template = templates[choice]["prompt"];
    model = templates[choice]["model"];
    max_tokens = templates[choice]["max_tokens"]; // How long the answer should be 
    temperature = templates[choice]["temperature"]; // How free-ranging the reply is 0-1 
    json_mode = templates[choice]["json_mode"];
    output_to = templates[choice]["output_to"];
    behavior = templates[choice]["behavior"];

    llm_prompt = template

    // remove comments
    llm_prompt = llm_prompt.replace(/\[\#[\s\S]*?\#\]/g, "");

    if (llm_prompt){
      abandon_prompt = 0;
      // Place selected text into template
      if (selectedText=="" && template.match(/{{highlighted}}/g)) {
        console.log("Unable to find highlighted/selected text for this page.");
        if (confirm('Unable to find highlighted/selected text for this page. Choose "OK" to continue with an empty value or "Cancel" to stop this template.') == true) {
          llm_prompt = llm_prompt.replace(/{{highlighted}}/g, ""); 
          llm_prompt = llm_prompt.replace(/{{nSelectedWords}}/g, 0); 
        } else {
          abandon_prompt = 1;
        }
      } else {
        if (selectedText.length>0) {
          llm_prompt = llm_prompt.replace(/{{highlighted}}/g, selectedText.replace(/({|})/g, "\\$1")); 
          try {
            llm_prompt = llm_prompt.replace(/{{nSelectedWords}}/g, selectedText.match(/\b(\w+)\b/g).length);             
          } catch (error) {
            llm_prompt = llm_prompt.replace(/{{nSelectedWords}}/g, "unknown");    
          }
        } else {
          llm_prompt = llm_prompt.replace(/{{highlighted}}/g, ""); 

          llm_prompt = llm_prompt.replace(/{{nSelectedWords}}/g, 0); 
        }
      }

      if (abandon_prompt == 0) {
        // Place page text into template
        if (bodyText=="" && template.match(/{{innerText}}/g)) {
          console.log("Unable to parse innerText for this page.");
          if (confirm('Unable to parse innerText for this page. Choose "OK" to continue with an empty value or "Cancel" to stop this prompt.') == true) {
            llm_prompt = llm_prompt.replace(/{{innerText}}/g, "");
            llm_prompt = llm_prompt.replace(/{{nWordsOnPage}}/g, 0);
          } else {
            abandon_prompt = 1;
          }
        } else {
          if (bodyText.length>0) {
            llm_prompt = llm_prompt.replace(/{{innerText}}/g, bodyText.replace(/({|})/g, "\\$1"));
            try {
              llm_prompt = llm_prompt.replace(/{{nWordsOnPage}}/g, bodyText.match(/\b(\w+)\b/g).length);              
            } catch (error) {
              llm_prompt = llm_prompt.replace(/{{nWordsOnPage}}/g, "unknown");       
            }
          } else {
            llm_prompt = llm_prompt.replace(/{{innerText}}/g, "");
            llm_prompt = llm_prompt.replace(/{{nWordsOnPage}}/g, 0);
          }
        }
      }

    } else {
      alert(`Can't read prompt. `)
      abandon_prompt = 1;

    }

    if (abandon_prompt == 0) {
      // Place scrtach pad text into template
      llm_prompt = llm_prompt.replace(/{{scratch}}/g, localStorage.getItem('scratch_pad'));
      try {
        console.log("Attempting to parse Scratch Pad for JSON...")
        scratch = JSON.parse(localStorage.getItem('scratch_pad').trim());
      } catch (error) {
        console.log("Scratch Pad isn't JSON.")
      }
      var scratchjson = llm_prompt.match(/{{scratch\["[a-zA-Z_-]+"\]}}/g);
      // Loop through each variable and present it as a question
      if (scratchjson) {
        console.log("Checking scratch...");
        for (item of scratchjson) {
            key = [...item.matchAll(/{{scratch\["([a-zA-Z_]+)"\]}}/g)][0][1];
            console.log(" - scratch[\""+key+"\"]="+scratch[key]);
            llm_prompt = llm_prompt.replace("{{scratch[\""+key+"\"]}}", scratch[key]);  
        }
      }
      

      llm_prompt = llm_prompt.replace(/{{passThrough}}/g, passThrough);
      var passThroughjson = llm_prompt.match(/{{passThrough\["[a-zA-Z_-]+"\]}}/g);
      // Loop through each variable and present it as a question
      if (passThroughjson) {
        console.log("Checking passThrough...");
        for (item of passThroughjson) {
            key = [...item.matchAll(/{{passThrough\["([a-zA-Z_]+)"\]}}/g)][0][1];
            console.log(" - passThrough[\""+key+"\"]="+passThrough[key]);
            llm_prompt = llm_prompt.replace("{{passThrough[\""+key+"\"]}}", passThrough[key]);  
        }
      }

      // ------------------------------------------------------
      // Add predefined variables to the the template
      // ------------------------------------------------------
    
      // Coin
      flip = Math.floor(Math.random() * 2)
      flip_out = ["heads","tails"]
      llm_prompt = llm_prompt.replace(/{{coinFlip}}/g,flip_out[flip]);
      // Dice 
      roll = Math.floor(Math.random() * 4) + 1
      llm_prompt = llm_prompt.replace(/{{d4}}/g,roll);
      roll = Math.floor(Math.random() * 6) + 1
      llm_prompt = llm_prompt.replace(/{{d6}}/g,roll);
      roll = Math.floor(Math.random() * 8) + 1
      llm_prompt = llm_prompt.replace(/{{d8}}/g,roll);
      roll = Math.floor(Math.random() * 10)
      llm_prompt = llm_prompt.replace(/{{d%}}/g,roll);
      roll = Math.floor(Math.random() * 12) + 1
      llm_prompt = llm_prompt.replace(/{{d12}}/g,roll);
      roll = Math.floor(Math.random() * 20) + 1
      llm_prompt = llm_prompt.replace(/{{d20}}/g,roll);

      // Dates 
      const d = new Date();
      const day_list = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      llm_prompt = llm_prompt.replace(/{{dayOfWeek}}/g, d.getDay()); // number
      llm_prompt = llm_prompt.replace(/{{DayOfWeek}}/g, day_list[d.getDay()]); // english
      const month_list = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      llm_prompt = llm_prompt.replace(/{{month}}/g, d.getMonth()); // number
      llm_prompt = llm_prompt.replace(/{{month2d}}/g, ('0'  + d.getMonth()).slice(-2)); // number
      llm_prompt = llm_prompt.replace(/{{Month}}/g, month_list[d.getMonth()]); // english
      llm_prompt = llm_prompt.replace(/{{day}}/g, d.getDate()); // day of month
      llm_prompt = llm_prompt.replace(/{{day2d}}/g, ('0'  + d.getDate()).slice(-2)); // day of month
      llm_prompt = llm_prompt.replace(/{{year}}/g, d.getFullYear()); // YEAR
      llm_prompt = llm_prompt.replace(/{{hours24}}/g, d.getHours()); // hours (out of 24)
      llm_prompt = llm_prompt.replace(/{{hours242d}}/g, ('0'  + d.getHours()).slice(-2)); // hours (out of 24)
      llm_prompt = llm_prompt.replace(/{{hours}}/g, (d.getHours() % 12 || 12)); // hours (out of 12)
      llm_prompt = llm_prompt.replace(/{{hours2d}}/g, ('0'  + (d.getHours() % 12 || 12)).slice(-2)); // hours (out of 12)
      llm_prompt = llm_prompt.replace(/{{ampm}}/g, d.getHours() >= 12 ? 'pm' : 'am');
      llm_prompt = llm_prompt.replace(/{{minutes}}/g, d.getMinutes());
      llm_prompt = llm_prompt.replace(/{{minutes2d}}/g, ('0'  + d.getMinutes()).slice(-2));
      llm_prompt = llm_prompt.replace(/{{seconds}}/g, d.getSeconds());
      llm_prompt = llm_prompt.replace(/{{seconds2d}}/g, ('0'  + d.getSeconds()).slice(-2));

      if (llm_prompt.trim()=="") {
        alert(`Error: Empty prompt. `)
        abandon_prompt = 1;
      } else {
        build_prompt();
      }
      
    }
  }

}

function scroll2Q(id) {
  document.getElementById('save_transcript').style.display='block';

  if (bubble>0 & visible_calls==0) {
    var top = document.getElementById(id).offsetTop; //Getting Y of target element
    console.log("Jump to Y for ("+id+"): "+top);
    //adapted from https://github.com/Yappli/smooth-scroll
    moving_frequency = 0.75
    var getScrollTopDocumentAtBegin = document.documentElement.scrollTop + document.body.scrollTop;
    console.log("Y:",top,getScrollTopDocumentAtBegin)
    var hop_count = Math.round((top - getScrollTopDocumentAtBegin)/moving_frequency)
    var gap = (top - getScrollTopDocumentAtBegin) / hop_count;
    for(var i = 1; i <= hop_count; i++)
        {
          (function()
            {
              var hop_top_position = gap*i;
                setTimeout(function(){  window.scrollTo(0, hop_top_position + getScrollTopDocumentAtBegin); }, moving_frequency*i);
              })();
        }
  }
}

function build_prompt() {
  console.log("Building prompt...");
  LLM_text_collection = "";
      
  // Make a list of all other variables (i.e. text of the form {{variable}}). 
  var questions = llm_prompt.match(/{{[^}]+}}/g)

  console.log("Questions:",questions)
  document.getElementById('button_list').style.display='none';
  document.getElementById('transcript').style.display='block';

  // Loop through each variable and present it as a question
  if (questions) {
    for (question of questions) {
      last_question = question;
      if ((!question_arry[question]) || (question.match(/\*}}$/))) {
        question_ = question.replace(/\*}}$/,"}}")
        question_ = question_.replace(/{|}/g,"");
        if (document.getElementById('thinking_box').style.display=="block") {
          setTimeout(() => {
            document.getElementById('thinking_box').style.display='none';
            document.getElementById('text_input').style.display='block';
            document.getElementById('user_input').focus({
              preventScroll:true
            });
            //document.getElementById('user_input').focus();
            bubble+=1;
            tmp_text = question_.replaceAll("\n\n---\n\n","\n\n~\n\n").replaceAll("---\n\n","");
            document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><a href='javascript:audio_play(`"+tmp_text.replaceAll("'","")+"`)' class='speak'>ðŸŽ§</a><div class='output_text'>"+tmp_text+"</div></div>";
            scroll2Q("text_"+bubble);
            document.getElementById("user_input").addEventListener("keydown", submitOnEnter);
          }, 300);        
        } else {
          document.getElementById('thinking_box').style.display='none';
          document.getElementById('text_input').style.display='block';
          document.getElementById('user_input').focus({
              preventScroll:true
            });
          //document.getElementById('user_input').focus();
          bubble+=1;
          tmp_text = question_.replaceAll("\n\n---\n\n","\n\n~\n\n").replaceAll("---\n\n","");
          document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><a href='javascript:audio_play(`"+tmp_text.replaceAll("'","")+"`)' class='speak'>ðŸŽ§</a><div class='output_text'>"+tmp_text+"</div></div>";
          scroll2Q("text_"+bubble);
          document.getElementById("user_input").addEventListener("keydown", submitOnEnter);
        }
        break
      } else {
        llm_prompt = llm_prompt.replaceAll(last_question,question_arry[last_question]);
        build_prompt(0);
        break
      }
    }
  } else {

    document.getElementById('thinking_box').style.display='block';

    // Count the words in the prompt
    words = llm_prompt.match(/\b(\w+)\b/g).length;
    token_est = Math.round(words*1.75)

    console.log("Words in prompt: "+words+" (~"+token_est+" tokens)\nMODEL: "+model+"\nPROMPT:\n\n"+llm_prompt)

    if (output_type==1) {
      console.log("Mode: Calling LLM")
      openai_call(llm_prompt)
    } else {
      console.log("Mode: Prompt only")
      after_build(llm_prompt)
    }
    
  }
}

function submit_text() {
  
  answer =  document.getElementById('user_input').value;
  if (answer.length>0) {
    console.log("Sending text...")
    calls=0;
    visible_calls = 0;
    document.getElementById('text_input').style.display='none'
    document.getElementById('thinking_box').style.display='block';
    bubble+=1;
    document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><div class='input_text'>"+answer+"</div></div>";
    scroll2Q("text_"+bubble);
    llm_prompt = llm_prompt.replaceAll(last_question, answer);
    question_arry[last_question] = answer;
    console.log("Q: "+question_+"\nA: "+answer);
    document.getElementById('user_input').value = "";
    build_prompt(0);  
  } else {
    alert("You cannot leave this input blank.");
    document.getElementById('user_input').focus();
  }
}

function saveAPICred() {
  localStorage.setItem("api_base",document.getElementById('api_base').value)
  localStorage.setItem("api_key",document.getElementById('api_key').value)
  document.getElementById('credentials').style.display='none';
  document.getElementById('output_window').innerHTML += "<div class='msg_text'>credentials saved</div>";
  insert_restart();
}

function saveOnEnter(event) {
  if (event.which === 13) {
      if (!event.repeat) {
        saveAPICred()
      }
      event.preventDefault(); // Prevents the addition of a new line in the text field
  }
}

function submitOnEnter(event) {
  if (!event.shiftKey && event.which === 13) {
      if (!event.repeat) {
        submit_text();
      }
      event.preventDefault(); // Prevents the addition of a new line in the text field
  }
}

function submit_chat_text() {
  answer =  document.getElementById('chat_user_input').value;
  if (answer.length>0) {
    console.log("Sending text...")
    calls=0;
    visible_calls=0;
    document.getElementById('chat_text_input').style.display='none'
    document.getElementById('thinking_box').style.display='block';
    bubble+=1;
    document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><div class='input_text'>"+answer+"</div></div>";
    scroll2Q("text_"+bubble);
    document.getElementById('chat_user_input').value = "";
    openai_call(answer)  
  } else {
    alert("You cannot leave this input blank.");
    document.getElementById('user_input').focus();
  }
}

function submitChatOnEnter(event) {
  if (!event.shiftKey && event.which === 13) {
      if (!event.repeat) {
        submit_chat_text();
      }
      event.preventDefault(); // Prevents the addition of a new line in the text field
  }
}

function submit_continue() {
  console.log("Sending continue request...")
  calls=0;
  visible_calls=0;
  document.getElementById('continue_gen').style.display='none';
  document.getElementById('thinking_box').style.display='block';
  openai_call("You got cutoff. Pickup where you left off and continue.")  
}

async function openai_call(prompt_text) {

  var xhr = new XMLHttpRequest();
  xhr.open("POST", api_base);

  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.setRequestHeader("Authorization", "Bearer "+api_key);

  xhr.onreadystatechange = function () {
     if (xhr.readyState === 4) {
      try {
        console.log(xhr.responseText);
        LLM_text = JSON.parse(xhr.responseText)["choices"][0]["message"]["content"];
        llm_messages.push({"role": "assistant", "content": LLM_text})
        after_build(LLM_text, JSON.parse(xhr.responseText)["choices"][0]["finish_reason"]);
      } catch (error) {
        llm_messages.pop();
        try {
          if (JSON.parse(xhr.responseText)["error"]["code"]=="context_length_exceeded") {
            est_token_limit = [...JSON.parse(xhr.responseText)["error"]["message"].matchAll(/\d+/g)]
            keep_n = Math.floor((est_token_limit[0] - max_tokens)/2);
            if (llm_messages.length==0) {
              console.log("ERROR: The prompt and its expected reply exceeds the token limit for this model.");
              LLM_text = "ERROR: The prompt and its expected reply exceeds the token limit for this model."
              output_to=0;
              behavior="stop"
              after_build(LLM_text)

            } else {
              console.log("ERROR: Over the course of this chat, you have reached the token limit for this model.");
              LLM_text = "ERROR: Over the course of this chat, you have reached the token limit for this model."
              output_to=0;
              behavior="stop"
              after_build(LLM_text)

            }
          } else if ((output_type==1) & (json_mode==1) & (JSON.parse(xhr.responseText)["error"]["message"].includes("response_format"))) {
            console.log("Removing json flag, trying again...")
            json_mode = 2;
            openai_call(prompt_text);
          } else {
            LLM_text = `There was an ERROR calling the LLM. Make sure you are using a valid endpoint and API Key. The credentials may have expired. Follow the directions under "Library Card" to get new ones.`
            output_to=0;
            behavior="stop"
            //LLM_text += "\n"+error            
            after_build(LLM_text);
            document.getElementById('restartButton').style.display='none';
            document.getElementById('credentials').style.display='block';
            document.getElementById('api_base').value = localStorage.api_base || "https://api.openai.com/v1/chat/completions";
            document.getElementById('api_key').value = localStorage.api_key || "";
            document.getElementById('api_key').focus();
          }            
        } catch (error) {
          LLM_text = `There was an ERROR calling the LLM. Make sure you are using a valid endpoint and API Key. The credentials may have expired. Follow the directions under "Library Card" to get new ones.`
          output_to=0;
          behavior="stop"
          //LLM_text += "\n"+error            
          after_build(LLM_text)
          document.getElementById('restartButton').style.display='none';
          document.getElementById('credentials').style.display='block';
          document.getElementById('api_base').value = localStorage.api_base || "https://api.openai.com/v1/chat/completions";
          document.getElementById('api_key').value = localStorage.api_key || "";
          document.getElementById('api_key').focus();
      }
      }
    }};

    if (behavior!="chat") { 
      llm_messages = []  
    }

    llm_messages.push({"role": "user", "content": prompt_text})
    var data = {
              "model": model, 
              "messages": llm_messages,
              "temperature": temperature,
              "max_tokens": max_tokens
            };

  if (json_mode==1) {
    console.log("Attempting JSON mode");
    data["response_format"]={ "type": "json_object" }  
  }

  console.log(data);

  return xhr.send(JSON.stringify(data));    
  
}


function accountForHTML(str) {
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function insert_restart(){
  document.getElementById('restartButton').style.display='block';
  document.getElementById("restartButton").focus(); 
}

function after_build(LLM_text,finish_reason="stop") {
  
  LLM_text_collection += LLM_text;

  // add line breaks for screen output
  LLM_text_formatted = accountForHTML(LLM_text);
  LLM_text_formatted = LLM_text_formatted.replaceAll(/```([^`]*)```\n?/g, "<pre class='code_wrapper'><code>$1</code></pre>");
  LLM_text_formatted = LLM_text_formatted.replaceAll(/`([^`]*)`/g, "<code>$1</code>");
  document.getElementById('thinking_box').style.display='none';

  // If not hidden
  if (output_to<4) {
    bubble+=1;
    tmp_text = LLM_text_formatted.replaceAll("\n\n---\n\n","\n\n~\n\n").replaceAll("---\n\n","");
    document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><a href='javascript:audio_play(`"+tmp_text.replaceAll("'","")+"`)' class='speak'>ðŸŽ§</a><div class='output_text' style='white-space: pre-wrap;'>"+tmp_text+"</div></div>";
    scroll2Q("text_"+bubble);
    visible_calls+=1;
  }

  // Check on json formatting
  if (json_mode>=1) {
    console.log("Attempting to parse JSON...")
    try {
      passThrough = JSON.parse(LLM_text_collection.trim());
      LLM_text_collection = JSON.stringify(passThrough, null, 2);        
    } catch (error) {
      alert("Warning: Output isn't JSON. Leaving as is! This may cause issues.")
      passThrough = LLM_text_collection;     
    }
  } else {
    passThrough = LLM_text_collection;
  }

  // Output location
  if (output_to==1) {
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output copied to clipboard</div>";
    copy_to_clipboard(LLM_text_collection);
  } else if (output_to==2) {
    //document.getElementById('scratch_pad').value += LLM_text_collection;
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output appended to scratch pad</div>";
    localStorage.setItem('scratch_pad', localStorage.getItem('scratch_pad')+LLM_text); // used LLM_text, not LLM_text_collection because will have already been appended
  } else if (output_to==3) {
    //document.getElementById('scratch_pad').value = LLM_text_collection;
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output replaced scratch pad</div>";
    localStorage.setItem('scratch_pad', LLM_text_collection);
  } else if (output_to==5) {
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output copied to clipboard</div>";
    copy_to_clipboard(LLM_text_collection);
  } else if (output_to==6) {
    //document.getElementById('scratch_pad').value += LLM_text_collection;
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output appended to scratch pad</div>";
    localStorage.setItem('scratch_pad', localStorage.getItem('scratch_pad')+LLM_text); // used LLM_text, not LLM_text_collection because will have already been appended
  } else if (output_to==7) {
    //document.getElementById('scratch_pad').value = LLM_text_collection;
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>above output replaced scratch pad</div>";
    localStorage.setItem('scratch_pad', LLM_text_collection);
  } 
  
  // Behavior

  if (finish_reason=="length"){
    document.getElementById('continue_gen').style.display='block';
    calls=0;
    visible_calls=0;
    scroll2Q("text_"+bubble); 

  } else if (behavior=="stop") {
    // End
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>end</div>";
    calls=0;
    visible_calls=0;
    insert_restart();
    scroll2Q("text_"+bubble); 

  } else if (behavior=="chat") {
    // Continue chat
    //document.getElementById('output_window').innerHTML += "<div class='msg_text'>engage with the above</div>";
    document.getElementById('chat_text_input').style.display='block';
    document.getElementById('chat_user_input').focus();
    calls=0;
    visible_calls=0;
    scroll2Q("text_"+bubble); 

  } else if (behavior=="file") {
    // Save to file
    document.getElementById('output_window').innerHTML += "<div class='msg_text'>triggered save to file</div>";
    calls=0;
    visible_calls=0;
    insert_restart();
    scroll2Q("text_"+bubble); 
    saveTextAsFile(LLM_text_collection,"my_story.txt")

  } else if (behavior=="pass") {
    // passThrough
    if (passThrough["next"]){
      try {
        choose_prompt(passThrough["next"])        
      } catch (error) {
        alert('No matching prompt found for "'+passThrough["next"]+'." Defaulting to FULL STOP')
        //document.getElementById('output_window').innerHTML += "<div class='msg_text'>end</div>";          
        calls=0;
        visible_calls=0;
        insert_restart();
        scroll2Q("text_"+bubble); 
      }
    } else {
      alert('No value found for passThrough["next"] defaulting to FULL STOP')
      //document.getElementById('output_window').innerHTML += "<div class='msg_text'>end</div>";
      calls=0;
      visible_calls=0;
      insert_restart();
      scroll2Q("text_"+bubble); 
    }

  } else {
    // Run another prompt
    choose_prompt(behavior)

  }

}


// Get the selected text
function getSelection() {
  const focusedElement = document.activeElement;

  if (focusedElement) {
    if (focusedElement.tagName.toLowerCase() === 'textarea' || focusedElement.tagName.toLowerCase() === 'input') {
      if (typeof focusedElement.selectionStart === 'number' && typeof focusedElement.selectionEnd === 'number') {
        selectedText = focusedElement.value.substring(focusedElement.selectionStart, focusedElement.selectionEnd);
      } else if (focusedElement.selectionStart === undefined) {
        // For input elements in some browsers like Firefox
        const selection = focusedElement.value.substring(
          focusedElement.selectionStart, focusedElement.selectionEnd
        );
        if (selection) {
          selectedText = selection;
        }
      }
    }
  }
  let body_text = localStorage.scratch_pad //document.getElementById('scratch_pad').value;

  console.log(selectedText,body_text)

  return [selectedText,body_text]
}

document.addEventListener('DOMContentLoaded', function () {
  templates = JSON.parse(localStorage.templates)
  const buttonList = document.getElementById('button_list');

  //templates.forEach(function(item, index) {
  for (const [key, value] of Object.entries(templates)) {

    if ((templates[key]["hide_button"]==false) && (((key!="Pick up where you left off") && (key!="Download current story") || (localStorage.getItem("scratch_pad")!="")))) {
      // Create button element
      const button = document.createElement('button');
      button.textContent = key; // Set button text
      button.id = `template_`+key.replace(/[^a-zA-Z]/g,"_"); // Set button id
      button.dataset.choice = key; // Set data-choice attribute
      button.style.width = '100%'; // Set styles
      button.style.marginBottom = '5px';

      // Add event listener to button
      button.addEventListener('mousedown', function() {
        text_arry = getSelection(); selectedText = text_arry[0]; bodyText = text_arry[1];
      });
      button.addEventListener('click', function() {
        choose_prompt(this.dataset.choice); // 'this' refers to the button clicked
      });

      // Append button to button list in DOM
      buttonList.appendChild(button);
    }

    if ((key=="Pick up where you left off") && (localStorage.getItem("scratch_pad")!="")) {
      // Edit current story
      const button = document.createElement('button');
      button.id = `edit_scratch` // Set button id
      button.textContent = "Edit current story in place"; // Set button text
      button.dataset.choice = "Edit current story in place"; // Set data-choice attribute
      button.style.width = '100%'; // Set styles
      button.style.marginBottom = '5px';
      buttonList.appendChild(button);
    } else if ((key=="Pick up where you left off") && (localStorage.getItem("scratch_pad")=="")) {
      // Open blank AI Story Editor
      const button = document.createElement('button');
      button.id = `edit_scratch` // Set button id
      button.textContent = "Open blank story editor"; // Set button text
      button.dataset.choice = "Edit current story in place"; // Set data-choice attribute
      button.style.width = '100%'; // Set styles
      button.style.marginBottom = '5px';
      buttonList.appendChild(button);

    }

  };



  // Create button element
  const button = document.createElement('button');
  button.id = `open_scratch` // Set button id
  button.textContent = "Upload story from file"; // Set button text
  button.dataset.choice = "Upload story from file"; // Set data-choice attribute
  button.style.width = '100%'; // Set styles
  button.style.marginBottom = '5px';

  // Add event listener to button
  //button.addEventListener('mousedown', function() {
  //  text_arry = getSelection(); selectedText = text_arry[0]; bodyText = text_arry[1];
  //});
  //button.addEventListener('click', function() {
    //alert('upload')
    // 'this' refers to the button clicked
  //});

  // Append button to button list in DOM
  buttonList.appendChild(button);
  
  start_spinner('thinking');

});

window.onbeforeunload = function () {
  window.scrollTo(0, 0);
}

document.addEventListener('DOMContentLoaded', function() {

  //if (localStorage.getItem("scratch_pad")!="") {
    var edit_scratch = document.getElementById('edit_scratch');
    document.getElementById('edit_scratch').addEventListener('click', function() {
        //document.location.href = "edit/";
        document.location.href = "storyeditor/";
    });
  //}
 
  var open_scratch = document.getElementById('open_scratch');
  document.getElementById('open_scratch').addEventListener('click', function() {
      if (confirm('This will replace the current story with the file you upload. Note: the file you upload should be a text file with the same format you would find in a downloaded story. Choose "OK" to continue or "Cancel" to keep things as they are. ') == true) {
          document.getElementById('fileInput').click(); // Trigger file input
      }
  });
  document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
          return;
      }

      const reader = new FileReader();
      var error_code = 0

      reader.onload = function(e) {
          const contents = e.target.result;
          if (contents.startsWith("You are the game master for a table-top role-playing game.")) {
            try {
                //document.getElementById('scratch_pad').value = contents
                localStorage.setItem('scratch_pad', contents);
                //const json = JSON.parse(contents);
                //updatePromptsFromJson(json); // Function to update prompts
            } catch (error) {
                error_code = 1;
                console.error("Error reading file: ", error);
                // Handle errors (invalid file, etc.)
            }
          } else {
            error_code = 1;
          }
          if (error_code==0) {
            location.reload();
          } else {
            alert("Something went wrong. Make sure the file you're trying to upload is a properly formated story file (i.e., formated like one you would download).")
          }
      };

      reader.readAsText(file);
  });

  //var save_scratch = document.getElementById('save_scratch');
  //save_scratch.addEventListener('click', function() {
  //    saveTextAsFile(document.getElementById('scratch_pad').value,"scratch_pad.txt")
  //});

  const searchParams = new URLSearchParams(window.location.search);
  var error_code = 0

  if (searchParams.has('text')){
    if (localStorage.getItem("scratch_pad")!="") {
        file = "starters/"+searchParams.get('text');
        fetch(file)
        .then((res) => res.text())
        .then((text) => {
          if (text.startsWith("You are the game master for a table-top role-playing game.")) {
            try {
                localStorage.setItem('scratch_pad', text);
            } catch (error) {
                error_code = 1;
                console.error("Error reading file: ", error);
            }
          } else {
            error_code = 1;
          }
          if (error_code==0) {
            tmp_text = text.split("========")
            tmp_text = tmp_text[tmp_text.length-1].trim()
            tmp_title = tmp_text.split("\n")[0]
            // do something with "text"
            if (confirm(`By clicking "OK" you will overwrite your current story, replacing it with the beginning of `+tmp_title.toUpperCase()+`. Choose "Cancel" to stop without loading `+tmp_title.toUpperCase()+`.`) == true) {
              bubble+=1;
              document.getElementById('unfinished').style.display='none';
              document.getElementById('transcript').style.display='block';
              document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><a href='javascript:audio_play(`"+tmp_text.replaceAll("'","")+"`)' class='speak'>ðŸŽ§</a><div class='output_text'>"+tmp_text.replaceAll("\n","<br>")+"</div></div>";
              visible_calls+=1;
              choose_prompt("Role Play 01");
              setTimeout(function(){  
                //window.scrollTo(0,0);
                visible_calls=0;
                scroll2Q("text_1");
                visible_calls+=1;
                var url= document.location.href;
                window.history.pushState({}, "", url.split("?")[0]);
              }, 1);
              
              //var url= document.location.href;
              //window.history.pushState({}, "", url.split("?")[0]);
              //location.reload();
            } else {
              var url= document.location.href;
              window.history.pushState({}, "", url.split("?")[0]);
            }
          } else {
            alert("Something went wrong. The file you're trying to read isn't there or is malformed.")
            var url= document.location.href;
            window.history.pushState({}, "", url.split("?")[0]);
          }
        })
        .catch((e) => console.error(e));
    } else {
        file = "starters/"+searchParams.get('text');
        fetch(file)
        .then((res) => res.text())
        .then((text) => {
          if (text.startsWith("You are the game master for a table-top role-playing game.")) {
            try {
                localStorage.setItem('scratch_pad', text);
            } catch (error) {
                error_code = 1;
                console.error("Error reading file: ", error);
            }
          } else {
            error_code = 1;
          }
          if (error_code==0) {
            tmp_text = text.split("========")
            tmp_text = tmp_text[tmp_text.length-1].trim()
            tmp_title = tmp_text.split("\n")[0]
            // do something with "text"
            bubble+=1;
            document.getElementById('unfinished').style.display='none';
            document.getElementById('transcript').style.display='block';
            document.getElementById('output_window').innerHTML += "<div class='text_wrap' id='text_"+bubble+"'><a href='javascript:audio_play(`"+tmp_text.replaceAll("'","")+"`)' class='speak'>ðŸŽ§</a><div class='output_text'>"+tmp_text.replaceAll("\n","<br>")+"</div></div>";
            visible_calls+=1;
            choose_prompt("Role Play 01");
            setTimeout(function(){  
              //window.scrollTo(0,0);
              visible_calls=0;
              scroll2Q("text_1");
              visible_calls+=1;
              var url= document.location.href;
              window.history.pushState({}, "", url.split("?")[0]);
            }, 1);
            
            //var url= document.location.href;
            //window.history.pushState({}, "", url.split("?")[0]);
            //location.reload();
          } else {
            alert("Something went wrong. The file you're trying to read isn't there or is malformed.")
            var url= document.location.href;
            window.history.pushState({}, "", url.split("?")[0]);
          }
        })
        .catch((e) => console.error(e));
    }
  }

});
</script>
<style>
	* {
		box-sizing: border-box;
	}

	input:focus, textarea {
		outline: none;
	}
	
	#main_wrapper {
		font-family: SÃ¶hne,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,Helvetica Neue,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;
		box-sizing: border-box;
	}

	#scratch_pad {
		box-sizing: border-box;
		width:100%;
		height:100%;
		padding:20px;
		border:0px solid #ccc;
		resize: none;
		overflow-y: auto;
	}

	.text_wrap{
		float:left;
		width:100%;
		margin:0;
		padding:0;
	}

	.input_text {
		float:right;
		font-size: 15px;
		line-height: 20px;
		margin: 0px 5px 15px 0;
		max-width:100%;
		margin-left:20%;
		background:#eee;
		border-radius:8px;
		padding:15px;
	}

	.output_text {
		float:left;
		background:#425dd4;
		font-size: 15px;
		line-height: 20px;
		color: white;
		border-radius:8px;
		margin: 0px 0 15px 0;
		max-width:80%;
		padding:15px;
	}

  a.speak {
    float:right;
    padding: 0px 3px 0 0;
    text-decoration: none;
  }

	code {
		background:#2c3e8e;
	}

	.code_wrapper {
		padding:3px;
		margin: 0px;
		width:100%;
		overflow-x: auto;
		background:#2c3e8e;
	}

	.msg_text {
		float:left;
		font-family: Verdana, Geneva, sans-serif;
		font-variant: small-caps;
		width:100%;
		text-align: center;
		font-size: 14px;
		color:#7d7878;
		margin:0 0 15px 0;
	}

	/* -- the below is needed for interactions -- */

	#button_list {
		margin-bottom: 0px;
	}

	#thinking_box{
		float:left;
		width:100%;
		display:none;
	}

	#thinking {
		width:43px;
		height:75px;
		margin:0 auto;
	}

	#user_input{
		width:100%;
		height:50px;
	}

	#chat_user_input{
		width:100%;
		height:50px;
	}

	#continue_gen {
		float:left;
		width:100%;
		margin: 0px 0 10px 0;
	}

	#continueButton{
		width:100%;
	}

	#credentials {
		float:left;
		width:100%;
		margin: 0px 0 10px 0;
	}

	#credentials_table{
		width:100%;
		margin: 0 0 5px 0;
	}

	#credentialsButton{
		width:100%;
	}

  #send {
    float:left;
    width: calc(100% - 180px);
    height: 27px;
    margin: 5px 5px 0px 0;
  }

  #random {
    float:right;
    width: 70px;
    height: 27px;
    margin: 5px 0px 0px 5px;
  }
  
  #restartButton_companion{
    float:left;
    width: 100px;
    height: 27px;
    margin: 5px 0 10px 0;
  }

	#restartButton{
		display:none;
		width:100%;
		margin: 0 0 10px 0;
	}


	#save_transcript{
		display:none;
		float:left;
		font-family: Verdana, Geneva, sans-serif;
		font-variant: small-caps;
		width:100%;
		text-align: center;
		font-size: 14px;
		color:#7d7878;
		margin:0 0 15px 0;
	}

	/*-- The below differes between export and non --*/

	.custom_header{
		margin: 0 0 10px 0;
	}

	#inline_scratch {
		display:none;
	}

	#main_wrapper{
		margin: 0px auto;
	}

	#inner_wrapper{
		height:100%;
		width:100%;
		padding: 0;
	}

  .footer{
    margin-top: 0;
  }
  

</style>
</head>
<BODY MARGINWIDTH="0" MARGINHEIGHT="0">

<!-- Message Banner -->
<div id="msg_bar" style="display:none;"></div>

<!-- Title and share -->
<div class="title_bar">
  <div class="home">
    <a href="javascript:void('')" tabindex="1" id="toggle-mode">ðŸŒ—</a>
  </div>  
  <div class="settings">
    <a href="settings/" tabindex="4"><img src="images/settings.png" class="settings_btn"></a>
  </div>
  <div id="share">
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style" data-a2a-url="https://libraryofunwrittenbooks.org/about/" data-a2a-title="About | The Library of Unwritten Books">
        <a class="a2a_dd" tabindex="3" href="https://www.addtoany.com/share"></a>
      </div>
  </div>
  <span id="title"><a href="./"  tabindex="2" class="title_home">The Library of Unwritten Books</a></span>
  <div id="subtitle">More stories than stars in the sky</div>
</div>

<!-- Menu -->
<div class="menu_bar">
  <a href="." class="menu_item choosen">Home</a>
  <a href="about/" class="menu_item">About</a>
  <a href="tips/" class="menu_item">Tips</a>
  <a href="card/" class="menu_item">Library Card</a>
</div>

<div class="content">
  <!-- START PAGE CONTENT -->
  <div id="page">
    To check out an unwritten book, answer 6 questions, then: read; reply; repeat. <a href="tips/">Remember</a>, as a reader-author, what you read is a reflection of what you and others have written, and where one ends a story is at least as important as where one begins. Respond in sentences. Ask to look around. Speak with others. Act upon the world. You are a reader-<b>author</b>. Act like it! 
  <hr/>

  <div id="main_wrapper">
    <div id="inner_wrapper">
      <!--
        START CUSTOM CONTENT
      -->
      <div class="custom_header"></div>
      <!--
        END CUSTOM CONTENT
      -->
      <div id="button_list"></div>
      <div id="transcript" style="display:none;">
        <div id="output_window"></div>
      </div>
      <div id="thinking_box">
        <div id="thinking"></div>
      </div>
      <div id="text_input" style="display:none;">
        <textarea id="user_input" autocapitalize="off" autocomplete="off"></textarea>
        <button id="send">Send</button>
        <button id="restartButton_companion">Back Home</button>
        <button id="random">ðŸŽ²</button>
      </div>
      <div id="chat_text_input" style="display:none;">
        <textarea id="chat_user_input" autocapitalize="off" autocomplete="off"></textarea>
        <button id="chat_send">Send</button>
        <button id="restartButton_companion">Back Home</button>
        <button id="random">ðŸŽ²</button>
      </div>
      <div id="continue_gen" style="display:none;">
        <button id='continueButton'>Continue text generation</button>
      </div>
      <a href="#" id="save_transcript">save transcript</a>
      <button id="restartButton">Back Home</button>
      <div id="credentials" style="display:none;">
        <table id="credentials_table">
          <tr><td>API&nbsp;Base:&nbsp;</td><td width="100%"><input id="api_base" style="width:100%"></td></tr>
          <tr><td>API&nbsp;Key:&nbsp;</td><td width="100%"><input id="api_key" style="width:100%"></td></tr>
        </table>        
        <button id='credentialsButton'>Update/Save Credentials</button>
      </div>
      <div id="choices" style="display:none;">
        <select id="toPrompt" style="width:100%;margin:5px 0 8px 0;text-align:center;">
          <option value="">Pass output to prompt (choose one)</option>
        </select>
      </div>
    </div>
  </div>

  </div>
  <div id="unfinished">
  <hr>
  <select autocomplete="off" onChange="window.location.href=this.value">
    <option value="" SELECTED>Test drive an unfinished book</option>
    <option value="?text=dragons_and_desks.txt">Dragons and Desk Jobs</option>
    <option value="?text=alice_and_ada.txt">Alice and the Thinking Machines</option>
    <option value="?text=pride_and_prejudice.txt">Pride and Prejudice with Androids</option>
  </select>
  <p style="text-align: center;">
    Want to see your story starter here? <a href="https://github.com/colarusso/library-of-unwritten-books/tree/main/starters#story-starters" target="_blank">Read this</a>.
  </p>
  </div>
  <!-- END PAGE CONTENT -->
  <p style="text-align: center;">
    <span style="color:rgb(112, 112, 112)"><i><a href="about/" style="color:rgb(112, 112, 112)">LLMs power the library</a>. I prepay for some usage each month, but when that runs out, folks need a <a href="card/" style="color:rgb(112, 112, 112)">library card</a>.</i></span>
  </p>
  <input type="file" id="fileInput" style="display: none;"/>
  <div class="footer">
    <span class="footer_links">
      <a href="./terms-et-al/">Terms &amp; Privacy</a> 
      | <a href="https://github.com/colarusso/library-of-unwritten-books/issues" target="_blank">Feedback</a> 
      | <a href="https://github.com/colarusso/library-of-unwritten-books" target="_blank">GitHub</a>
    </span>
    <span class="byline">Site by <a href="https://mastodon.social/@Colarusso" target="_blank">David Colarusso</a></span>
  </div>
</div>

</BODY></HTML>
